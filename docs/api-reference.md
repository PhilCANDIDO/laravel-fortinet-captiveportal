# API Reference

## Laravel Fortinet Captive Portal - Technical Documentation

**Version:** 1.0.0  
**Last Updated:** January 2025  
**API Version:** v1  
**FortiGate API:** v2 (FortiOS 7.6.3+)

---

## Table of Contents

1. [Overview](#overview)
2. [Authentication](#authentication)
3. [Guest API Endpoints](#guest-api-endpoints)
4. [Admin API Endpoints](#admin-api-endpoints)
5. [FortiGate Integration](#fortigate-integration)
6. [WebSocket Events](#websocket-events)
7. [Error Handling](#error-handling)
8. [Rate Limiting](#rate-limiting)
9. [Code Examples](#code-examples)
10. [Testing](#testing)

---

## Overview

### Base URLs

| Environment | URL |
|------------|-----|
| **Production** | `https://captiveportal.example.com/api/v1` |
| **Staging** | `https://staging.captiveportal.example.com/api/v1` |
| **Development** | `http://captiveportal.test/api/v1` |

### Request/Response Format

- **Content-Type:** `application/json`
- **Accept:** `application/json`
- **Charset:** `UTF-8`

### HTTP Methods

- `GET` - Retrieve resources
- `POST` - Create new resources
- `PUT`/`PATCH` - Update resources
- `DELETE` - Delete resources

### Status Codes

| Code | Description |
|------|-------------|
| 200 | OK - Request successful |
| 201 | Created - Resource created |
| 204 | No Content - Successful with no response body |
| 400 | Bad Request - Invalid parameters |
| 401 | Unauthorized - Authentication required |
| 403 | Forbidden - Access denied |
| 404 | Not Found - Resource not found |
| 422 | Unprocessable Entity - Validation errors |
| 429 | Too Many Requests - Rate limit exceeded |
| 500 | Internal Server Error |
| 503 | Service Unavailable |

---

## Authentication

### Session-Based Authentication

The application uses Laravel's session-based authentication for web requests.

#### CSRF Protection

All POST, PUT, PATCH, and DELETE requests require a CSRF token:

```html
<!-- In forms -->
@csrf

<!-- In AJAX requests -->
headers: {
    'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]').content
}
```

### Admin Authentication

Admin endpoints require authentication through the admin guard.

#### Login

```http
POST /admin/login
```

**Request Body:**
```json
{
    "email": "admin@example.com",
    "password": "SecurePassword123!",
    "remember": true
}
```

**Response:**
```json
{
    "success": true,
    "message": "Login successful",
    "redirect": "/admin/dashboard",
    "requires_mfa": true
}
```

#### MFA Verification

```http
POST /admin/mfa/verify
```

**Request Body:**
```json
{
    "code": "123456",
    "remember_device": true
}
```

**Response:**
```json
{
    "success": true,
    "message": "MFA verification successful",
    "redirect": "/admin/dashboard"
}
```

#### Logout

```http
POST /admin/logout
```

**Response:**
```json
{
    "success": true,
    "message": "Logged out successfully",
    "redirect": "/admin/login"
}
```

---

## Public Endpoints

### Guest Registration

#### Register Guest

```http
POST /guest/register
```

**Request Body:**
```json
{
    "first_name": "John",
    "last_name": "Doe",
    "email": "john.doe@example.com",
    "company": "Example Corp",
    "visit_reason": "Meeting",
    "contact_person": "Jane Smith",
    "accept_charter": true,
    "portal_data": "base64_encoded_portal_data",
    "locale": "en"
}
```

**Response:**
```json
{
    "success": true,
    "message": "Registration successful",
    "data": {
        "username": "guest-1234",
        "password": "AutoGenerated123!",
        "expires_at": "2025-08-20T10:00:00Z",
        "validation_required": true,
        "validation_expires_at": "2025-08-19T10:30:00Z",
        "portal_url": "http://192.168.1.1:1000/fgtauth?..."
    }
}
```

#### Validate Email

```http
GET /guest/validate/{token}
```

**URL Parameters:**
- `token` - Signed validation token from email

**Response:**
```json
{
    "success": true,
    "message": "Email validated successfully",
    "data": {
        "username": "guest-1234",
        "expires_at": "2025-08-20T10:00:00Z"
    }
}
```

### Language Management

#### Change Language

```http
GET /locale/{locale}
```

**URL Parameters:**
- `locale` - Language code (fr, en, it, es)

**Response:**
```json
{
    "success": true,
    "message": "Language changed",
    "locale": "fr"
}
```

### Landing Page

#### Post-Authentication Landing

```http
GET /landing
```

**Query Parameters:**
- `username` - FortiGate username
- `status` - Authentication status (success/failure)
- `ip` - Client IP address
- `mac` - Client MAC address

**Response:** HTML page with status information

---

## Admin Endpoints

### User Management

#### List Users

```http
GET /admin/users/{type}
```

**URL Parameters:**
- `type` - User type (employees, consultants, guests)

**Query Parameters:**
- `page` - Page number (default: 1)
- `per_page` - Items per page (default: 10)
- `search` - Search term
- `status` - Filter by status (active, expired, suspended)
- `sort_by` - Sort field (name, email, created_at)
- `sort_order` - Sort order (asc, desc)

**Response:**
```json
{
    "data": [
        {
            "id": 1,
            "name": "John Doe",
            "email": "john@example.com",
            "user_type": "guest",
            "status": "active",
            "expires_at": "2025-08-20T10:00:00Z",
            "fortigate_username": "guest-1234",
            "fortigate_sync_status": "synced",
            "created_at": "2025-08-19T10:00:00Z"
        }
    ],
    "meta": {
        "current_page": 1,
        "per_page": 10,
        "total": 100,
        "last_page": 10
    }
}
```

#### Create User

```http
POST /admin/users
```

**Request Body:**
```json
{
    "user_type": "consultant",
    "name": "Jane Smith",
    "email": "jane@example.com",
    "company_name": "Example Corp",
    "department": "IT",
    "sponsor_name": "John Manager",
    "sponsor_email": "manager@example.com",
    "expires_at": "2025-09-19T10:00:00Z",
    "send_credentials": true
}
```

**Response:**
```json
{
    "success": true,
    "message": "User created successfully",
    "data": {
        "id": 123,
        "username": "consultant-123",
        "password": "AutoGenerated456!",
        "fortigate_username": "consultant-123"
    }
}
```

#### Update User

```http
PUT /admin/users/{id}
```

**Request Body:**
```json
{
    "name": "Jane Smith Updated",
    "expires_at": "2025-10-19T10:00:00Z",
    "status": "active"
}
```

**Response:**
```json
{
    "success": true,
    "message": "User updated successfully",
    "data": {
        "id": 123,
        "name": "Jane Smith Updated",
        "expires_at": "2025-10-19T10:00:00Z"
    }
}
```

#### Suspend/Activate User

```http
POST /admin/users/{id}/suspend
POST /admin/users/{id}/activate
```

**Response:**
```json
{
    "success": true,
    "message": "User suspended successfully",
    "data": {
        "id": 123,
        "status": "suspended",
        "fortigate_sync_status": "synced"
    }
}
```

#### Delete User

```http
DELETE /admin/users/{id}
```

**Response:**
```json
{
    "success": true,
    "message": "User deleted successfully"
}
```

#### Force Disconnect User

```http
POST /admin/users/{id}/deauth
```

**Response:**
```json
{
    "success": true,
    "message": "User disconnected successfully",
    "data": {
        "sessions_terminated": 2,
        "fortigate_response": "success"
    }
}
```

### Bulk Operations

#### Bulk Delete Users

```http
POST /admin/users/bulk-delete
```

**Request Body:**
```json
{
    "user_ids": [1, 2, 3, 4, 5]
}
```

**Response:**
```json
{
    "success": true,
    "message": "5 users deleted successfully",
    "data": {
        "deleted": 5,
        "failed": 0
    }
}
```

#### Export Users

```http
GET /admin/users/export
```

**Query Parameters:**
- `type` - User type filter
- `status` - Status filter
- `date_from` - Start date (Y-m-d)
- `date_to` - End date (Y-m-d)
- `format` - Export format (excel, csv)

**Response:** File download (application/vnd.ms-excel)

### Audit Logs

#### List Audit Logs

```http
GET /admin/audit
```

**Query Parameters:**
- `page` - Page number
- `per_page` - Items per page
- `event` - Event type filter
- `user_id` - User ID filter
- `admin_id` - Admin ID filter
- `date_from` - Start date
- `date_to` - End date

**Response:**
```json
{
    "data": [
        {
            "id": 1,
            "event": "user_created",
            "auditable_type": "App\\Models\\User",
            "auditable_id": 123,
            "old_values": null,
            "new_values": {
                "name": "John Doe",
                "email": "john@example.com"
            },
            "admin_email": "admin@example.com",
            "ip_address": "192.168.1.100",
            "created_at": "2025-08-19T10:00:00Z"
        }
    ],
    "meta": {
        "current_page": 1,
        "total": 1000
    }
}
```

#### Export Audit Logs

```http
GET /admin/audit/export
```

**Query Parameters:** Same as list endpoint

**Response:** Excel file download

### System Configuration

#### Get Settings

```http
GET /admin/settings
```

**Response:**
```json
{
    "data": {
        "general": {
            "guest_validation_required": true,
            "validation_timeout_minutes": 30,
            "guest_duration_hours": 24,
            "audit_retention_days": 365
        },
        "fortigate": {
            "api_url": "https://192.168.1.1",
            "user_group": "portal_users",
            "ssl_verification": true,
            "connection_status": "connected"
        },
        "email": {
            "smtp_host": "smtp.example.com",
            "smtp_port": 587,
            "smtp_encryption": "tls",
            "from_address": "noreply@example.com"
        }
    }
}
```

#### Update Settings

```http
PUT /admin/settings/{category}
```

**Request Body (FortiGate example):**
```json
{
    "api_url": "https://192.168.1.1",
    "api_token": "new-token-here",
    "user_group": "portal_users",
    "ssl_verification": true
}
```

**Response:**
```json
{
    "success": true,
    "message": "Settings updated successfully"
}
```

#### Test FortiGate Connection

```http
POST /admin/settings/fortigate/test
```

**Response:**
```json
{
    "success": true,
    "message": "FortiGate connection successful",
    "data": {
        "api_version": "v2",
        "fortigate_version": "7.6.3",
        "user_group_exists": true,
        "test_user_created": true,
        "test_user_deleted": true
    }
}
```

### Dashboard Statistics

#### Get Dashboard Data

```http
GET /admin/dashboard/stats
```

**Response:**
```json
{
    "data": {
        "users": {
            "total": 500,
            "by_type": {
                "employees": 50,
                "consultants": 100,
                "guests": 350
            },
            "active": 200,
            "expired": 150,
            "pending_validation": 10
        },
        "system": {
            "fortigate_status": "connected",
            "queue_status": "running",
            "failed_jobs": 0,
            "last_sync": "2025-08-19T10:00:00Z"
        },
        "recent_activity": [
            {
                "event": "user_registered",
                "user": "john@example.com",
                "time": "2025-08-19T09:55:00Z"
            }
        ]
    }
}
```

---

## FortiGate Integration

### FortiGate API Endpoints

The application integrates with FortiGate REST API v2.

#### User Management

##### Create User

```http
POST /api/v2/cmdb/user/local
```

**Headers:**
```
Authorization: Bearer {api_token}
Content-Type: application/json
```

**Request Body:**
```json
{
    "name": "guest-1234",
    "status": "enable",
    "type": "password",
    "passwd": "SecurePassword123!",
    "email": "guest@example.com",
    "two-factor": "disable",
    "comments": "Guest user - expires 2025-08-20"
}
```

##### Update User

```http
PUT /api/v2/cmdb/user/local/{username}
```

**Request Body:**
```json
{
    "status": "disable"
}
```

##### Delete User

```http
DELETE /api/v2/cmdb/user/local/{username}
```

#### Session Management

##### Get Active Sessions

```http
GET /api/v2/monitor/user/firewall/
```

**Query Parameters:**
- `filter` - Filter expression (e.g., `username=@guest-1234`)

**Response:**
```json
{
    "results": [
        {
            "id": 123,
            "username": "guest-1234",
            "ipaddr": "192.168.1.100",
            "method": "Firewall",
            "expiry": 86400,
            "traffic": 1048576
        }
    ]
}
```

##### Deauthenticate Session

```http
POST /api/v2/monitor/user/firewall/deauth
```

**Request Body:**
```json
{
    "user_type": "firewall",
    "id": 123,
    "ip": "192.168.1.100",
    "ip_version": "ip4",
    "method": "Firewall"
}
```

### Portal Data Integration

#### Portal Data Structure

Portal data is passed as base64-encoded JSON:

```json
{
    "portal_url": "http://192.168.20.1:1000/fgtauth",
    "magic": "MAGIC_TOKEN_HERE",
    "ssid": "Guest-WiFi",
    "ip": "192.168.20.105",
    "mac": "00:11:22:33:44:55",
    "type": "wireless"
}
```

#### Encoding Portal Data

```javascript
// JavaScript example
const portalData = {
    portal_url: window.location.origin + window.location.pathname,
    magic: getMagicToken(),
    ssid: getSSID(),
    ip: getClientIP()
};

const encoded = btoa(JSON.stringify(portalData));
```

#### Using Portal Data

```php
// PHP example
$portalData = base64_decode($request->portal_data);
$data = json_decode($portalData, true);

// Generate auto-auth URL
$authUrl = $data['portal_url'] . '?' . $data['magic'];
$authUrl .= '&auto_username=' . $username;
$authUrl .= '&auto_password=' . $password;
```

---

## Background Jobs

### Job Queue System

The application uses Laravel's queue system with multiple queues:

| Queue | Purpose | Priority |
|-------|---------|----------|
| default | General jobs | Normal |
| emails | Email sending | High |
| deletions | User deletions | Low |

### Available Jobs

#### DeleteUnvalidatedGuestJob

Deletes guests who haven't validated email within 30 minutes.

**Dispatch:**
```php
DeleteUnvalidatedGuestJob::dispatch($userId)
    ->delay(now()->addMinutes(30));
```

**Payload:**
```json
{
    "userId": 123
}
```

#### ExpireUsersJob

Processes expired users (hourly schedule).

**Dispatch:**
```php
ExpireUsersJob::dispatch();
```

#### DeleteExpiredGuestsJob

Deletes expired guest accounts (every 30 minutes).

**Dispatch:**
```php
DeleteExpiredGuestsJob::dispatch();
```

#### SendExpirationReminderJob

Sends expiration reminders (daily at 9 AM).

**Dispatch:**
```php
SendExpirationReminderJob::dispatch();
```

### Manual Job Execution

```bash
# Dispatch job manually
php artisan tinker
>>> App\Jobs\DeleteExpiredGuestsJob::dispatch();

# Process queue immediately
php artisan queue:work --stop-when-empty
```

---

## WebSocket Events

*Note: WebSocket implementation is optional and requires Laravel Echo/Pusher configuration.*

### Available Events

#### UserRegistered

Broadcast when a new user registers.

**Channel:** `private-admin`

**Event Data:**
```json
{
    "user": {
        "id": 123,
        "name": "John Doe",
        "email": "john@example.com",
        "user_type": "guest"
    }
}
```

#### UserExpired

Broadcast when a user account expires.

**Channel:** `private-admin`

**Event Data:**
```json
{
    "user_id": 123,
    "username": "guest-1234",
    "expired_at": "2025-08-20T10:00:00Z"
}
```

### Listening to Events

```javascript
// JavaScript with Laravel Echo
Echo.private('admin')
    .listen('UserRegistered', (e) => {
        console.log('New user registered:', e.user);
        updateDashboard();
    })
    .listen('UserExpired', (e) => {
        console.log('User expired:', e.user_id);
        refreshUserList();
    });
```

---

## Error Handling

### Error Response Format

All errors follow a consistent format:

```json
{
    "success": false,
    "message": "Error description",
    "errors": {
        "field_name": [
            "Validation error message"
        ]
    },
    "error_code": "SPECIFIC_ERROR_CODE"
}
```

### Common Error Codes

| Code | Description | HTTP Status |
|------|-------------|-------------|
| `VALIDATION_ERROR` | Input validation failed | 422 |
| `AUTHENTICATION_REQUIRED` | User not authenticated | 401 |
| `PERMISSION_DENIED` | Insufficient permissions | 403 |
| `RESOURCE_NOT_FOUND` | Resource doesn't exist | 404 |
| `FORTIGATE_CONNECTION_ERROR` | FortiGate API unreachable | 503 |
| `FORTIGATE_AUTH_ERROR` | FortiGate authentication failed | 401 |
| `USER_ALREADY_EXISTS` | Duplicate user | 409 |
| `VALIDATION_EXPIRED` | Email validation timeout | 410 |
| `RATE_LIMIT_EXCEEDED` | Too many requests | 429 |
| `INTERNAL_ERROR` | Server error | 500 |

### Validation Errors

```json
{
    "success": false,
    "message": "The given data was invalid.",
    "errors": {
        "email": [
            "The email field is required.",
            "The email must be a valid email address."
        ],
        "password": [
            "The password must be at least 12 characters."
        ]
    }
}
```

---

## Rate Limiting

### Default Limits

| Endpoint | Limit | Window |
|----------|-------|--------|
| Guest Registration | 5 requests | 1 minute |
| Email Validation | 10 requests | 1 minute |
| Admin Login | 5 requests | 1 minute |
| API Calls | 60 requests | 1 minute |
| Export Operations | 10 requests | 1 hour |

### Rate Limit Headers

```http
X-RateLimit-Limit: 60
X-RateLimit-Remaining: 45
X-RateLimit-Reset: 1629456789
```

### Rate Limit Exceeded Response

```json
{
    "success": false,
    "message": "Too many requests. Please try again later.",
    "error_code": "RATE_LIMIT_EXCEEDED",
    "retry_after": 60
}
```

---

## Code Examples

### PHP/cURL

#### Guest Registration

```php
<?php
$curl = curl_init();

$data = [
    'first_name' => 'John',
    'last_name' => 'Doe',
    'email' => 'john@example.com',
    'company' => 'Example Corp',
    'accept_charter' => true
];

curl_setopt_array($curl, [
    CURLOPT_URL => 'https://captiveportal.example.com/guest/register',
    CURLOPT_RETURNTRANSFER => true,
    CURLOPT_POST => true,
    CURLOPT_POSTFIELDS => json_encode($data),
    CURLOPT_HTTPHEADER => [
        'Content-Type: application/json',
        'Accept: application/json'
    ]
]);

$response = curl_exec($curl);
$httpCode = curl_getinfo($curl, CURLINFO_HTTP_CODE);
curl_close($curl);

$result = json_decode($response, true);

if ($httpCode === 200 && $result['success']) {
    echo "Username: " . $result['data']['username'] . "\n";
    echo "Password: " . $result['data']['password'] . "\n";
}
?>
```

### JavaScript/Fetch

#### Admin Login with MFA

```javascript
// Step 1: Login
async function login(email, password) {
    const response = await fetch('/admin/login', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]').content
        },
        body: JSON.stringify({ email, password })
    });
    
    const data = await response.json();
    
    if (data.requires_mfa) {
        // Prompt for MFA code
        const code = prompt('Enter MFA code:');
        return verifyMFA(code);
    }
    
    return data;
}

// Step 2: MFA Verification
async function verifyMFA(code) {
    const response = await fetch('/admin/mfa/verify', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]').content
        },
        body: JSON.stringify({ code })
    });
    
    return response.json();
}

// Usage
login('admin@example.com', 'password123')
    .then(result => {
        if (result.success) {
            window.location.href = result.redirect;
        }
    });
```

### Python

#### Bulk User Creation

```python
import requests
import json

class CaptivePortalAPI:
    def __init__(self, base_url, session_cookie=None):
        self.base_url = base_url
        self.session = requests.Session()
        if session_cookie:
            self.session.cookies.set('laravel_session', session_cookie)
    
    def create_users(self, users):
        """Create multiple users"""
        results = []
        
        for user in users:
            response = self.session.post(
                f"{self.base_url}/admin/users",
                json=user,
                headers={'Accept': 'application/json'}
            )
            
            if response.status_code == 201:
                results.append({
                    'email': user['email'],
                    'success': True,
                    'data': response.json()['data']
                })
            else:
                results.append({
                    'email': user['email'],
                    'success': False,
                    'error': response.json()['message']
                })
        
        return results

# Usage
api = CaptivePortalAPI('https://captiveportal.example.com', 'session_cookie_here')

users = [
    {
        'user_type': 'consultant',
        'name': 'John Doe',
        'email': 'john@example.com',
        'company_name': 'Example Corp',
        'expires_at': '2025-09-19T10:00:00Z'
    },
    {
        'user_type': 'consultant',
        'name': 'Jane Smith',
        'email': 'jane@example.com',
        'company_name': 'Example Corp',
        'expires_at': '2025-09-19T10:00:00Z'
    }
]

results = api.create_users(users)
for result in results:
    if result['success']:
        print(f"Created: {result['email']} - Username: {result['data']['username']}")
    else:
        print(f"Failed: {result['email']} - Error: {result['error']}")
```

### Bash/cURL

#### Export Audit Logs

```bash
#!/bin/bash

# Configuration
BASE_URL="https://captiveportal.example.com"
SESSION_COOKIE="your_session_cookie_here"
CSRF_TOKEN="your_csrf_token_here"

# Export audit logs for last 7 days
curl -X GET "${BASE_URL}/admin/audit/export" \
    -H "Cookie: laravel_session=${SESSION_COOKIE}" \
    -H "X-CSRF-TOKEN: ${CSRF_TOKEN}" \
    -H "Accept: application/vnd.ms-excel" \
    -G \
    --data-urlencode "date_from=$(date -d '7 days ago' '+%Y-%m-%d')" \
    --data-urlencode "date_to=$(date '+%Y-%m-%d')" \
    --data-urlencode "format=excel" \
    -o "audit_logs_$(date '+%Y%m%d').xlsx"

echo "Audit logs exported to audit_logs_$(date '+%Y%m%d').xlsx"
```

### Laravel/Artisan

#### Custom Command Integration

```php
<?php

namespace App\Console\Commands;

use App\Services\UserService;
use Illuminate\Console\Command;

class ImportUsers extends Command
{
    protected $signature = 'users:import {file : CSV file path}';
    protected $description = 'Import users from CSV file';
    
    public function handle(UserService $userService)
    {
        $file = $this->argument('file');
        
        if (!file_exists($file)) {
            $this->error("File not found: {$file}");
            return 1;
        }
        
        $csv = array_map('str_getcsv', file($file));
        $headers = array_shift($csv);
        
        $this->info("Importing " . count($csv) . " users...");
        
        $bar = $this->output->createProgressBar(count($csv));
        
        foreach ($csv as $row) {
            $data = array_combine($headers, $row);
            
            try {
                $user = $userService->createUser([
                    'user_type' => $data['type'],
                    'name' => $data['name'],
                    'email' => $data['email'],
                    'company_name' => $data['company'] ?? null,
                    'expires_at' => $data['expires_at'] ?? null
                ]);
                
                $this->line("\nCreated: {$user->email} ({$user->fortigate_username})");
            } catch (\Exception $e) {
                $this->error("\nFailed: {$data['email']} - {$e->getMessage()}");
            }
            
            $bar->advance();
        }
        
        $bar->finish();
        $this->info("\nImport completed!");
        
        return 0;
    }
}
```

---

## Testing

### Postman Collection

Import this collection for API testing:

```json
{
    "info": {
        "name": "Captive Portal API",
        "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
    },
    "variable": [
        {
            "key": "base_url",
            "value": "http://captiveportal.test"
        },
        {
            "key": "csrf_token",
            "value": ""
        }
    ],
    "item": [
        {
            "name": "Guest Registration",
            "request": {
                "method": "POST",
                "header": [
                    {
                        "key": "Content-Type",
                        "value": "application/json"
                    },
                    {
                        "key": "X-CSRF-TOKEN",
                        "value": "{{csrf_token}}"
                    }
                ],
                "body": {
                    "mode": "raw",
                    "raw": "{\n    \"first_name\": \"Test\",\n    \"last_name\": \"User\",\n    \"email\": \"test@example.com\",\n    \"accept_charter\": true\n}"
                },
                "url": {
                    "raw": "{{base_url}}/guest/register",
                    "host": ["{{base_url}}"],
                    "path": ["guest", "register"]
                }
            }
        }
    ]
}
```

### Unit Testing

```php
<?php

namespace Tests\Feature;

use Tests\TestCase;
use App\Models\User;

class GuestRegistrationTest extends TestCase
{
    public function test_guest_can_register()
    {
        $response = $this->postJson('/guest/register', [
            'first_name' => 'Test',
            'last_name' => 'User',
            'email' => 'test@example.com',
            'company' => 'Test Company',
            'accept_charter' => true
        ]);
        
        $response->assertStatus(200)
                 ->assertJson([
                     'success' => true
                 ])
                 ->assertJsonStructure([
                     'data' => [
                         'username',
                         'password',
                         'expires_at'
                     ]
                 ]);
        
        $this->assertDatabaseHas('users', [
            'email' => 'test@example.com',
            'user_type' => 'guest'
        ]);
    }
}
```

---

## Webhooks

### Webhook Configuration

Configure webhooks for external integrations:

```php
// config/webhooks.php
return [
    'user_registered' => env('WEBHOOK_USER_REGISTERED'),
    'user_expired' => env('WEBHOOK_USER_EXPIRED'),
    'user_validated' => env('WEBHOOK_USER_VALIDATED')
];
```

### Webhook Payload

#### User Registered

```json
{
    "event": "user.registered",
    "timestamp": "2025-08-19T10:00:00Z",
    "data": {
        "id": 123,
        "username": "guest-1234",
        "email": "user@example.com",
        "user_type": "guest",
        "expires_at": "2025-08-20T10:00:00Z"
    }
}
```

### Webhook Security

All webhooks include HMAC signature validation:

```php
// Verify webhook signature
$payload = $request->getContent();
$signature = hash_hmac('sha256', $payload, config('webhooks.secret'));

if ($signature !== $request->header('X-Webhook-Signature')) {
    abort(401, 'Invalid signature');
}
```

---

## Migration Guide

### From v0.x to v1.0

#### Breaking Changes

1. **API Endpoints:**
   - `/api/guest/register` → `/guest/register`
   - `/api/admin/*` → `/admin/*`

2. **Authentication:**
   - Token-based auth removed
   - Session-based auth only

3. **Database:**
   - Run migrations: `php artisan migrate`
   - Update user types: `employee`, `consultant`, `guest`

#### Migration Steps

```bash
# 1. Backup database
mysqldump captive_portal > backup.sql

# 2. Update code
git pull origin main
composer install

# 3. Run migrations
php artisan migrate

# 4. Update configuration
php artisan config:cache

# 5. Restart services
php artisan queue:restart
php artisan horizon:terminate
```

---

## Support

### Resources

- **GitHub Repository:** [laravel-fortinet-captiveportal](https://github.com/PhilCANDIDO/laravel-fortinet-captiveportal)
- **Issue Tracker:** [GitHub Issues](https://github.com/PhilCANDIDO/laravel-fortinet-captiveportal/issues)
- **Documentation:** This document and accompanying guides

### Contact

- **Technical Support:** support@emerging-it.fr
- **Author:** Philippe CANDIDO
- **LinkedIn:** [philippe-candido](https://www.linkedin.com/in/philippe-candido-0056831)

---

**© 2025 Emerging IT - All rights reserved**